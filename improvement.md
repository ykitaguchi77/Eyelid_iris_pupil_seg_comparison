# 改善・工夫点の記録

このファイルでは、エラー対処や上手くいった工夫点を記録し、次に活かせるようにします。

## 環境構築時の工夫

### ライブラリの依存関係
- **問題**: PyTorch 2.9.0（CPU版）をインストールしたが、GPU版が必要だった
- **解決**: GPU版のPyTorch（2.6.0+cu124）に切り替え
- **コマンド**: `pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124`
- **教訓**: CUDAバージョンとPyTorchの互換性を確認してからインストール

### ライブラリの不足
- **問題**: process_data.ipynbでpandas, scikit-learn, opencv-pythonが不足
- **解決**: 一括インストールしてrequirements.txtを更新
- **教訓**: 使用するライブラリは最初にrequirements.txtに記載しておく

## データ前処理での工夫

### CVAT XMLのパース
- **決定**: polygonとellipseを別々に処理
- **理由**: eyelid_caruncle_seg_0-2000.xmlはpolygon、obb_iris_pupil_1-3000.xmlはellipse
- **工夫**: `parse_cvat_xml`関数で統一的な処理を実装

### 画像座標の正規化
- **問題**: 元画像のサイズが異なる（956×956、979×979など）
- **解決**: 640×640に統一する際に正規化して座標を変換
- **関数**: `rasterize_polygon`, `rasterize_ellipse`で統一処理

### 楕円のラスタライズ
- **決定**: PILのImageDrawを使用
- **理由**: OpenCVよりも楕円の描画が綺麗
- **関数**: `rasterize_ellipse`で実装

### データの一貫性保証
- **問題**: 瞳孔が虹彩の外に出ることがある
- **解決**: `E_pupil ← E_pupil ∩ E_iris`を強制
- **実装**: `mask_pupil = np.bitwise_and(mask_pupil, mask_iris)`

### GroupKFoldによる患者分割
- **重要性**: 同一患者がtrain/valを跨ぐとリークになる
- **実装**: scikit-learnの`GroupKFold(n_splits=5, groups=patient_id)`
- **確認**: 各foldで患者重複をチェック

## ファイル構造の工夫

### 保存先の明確化
- **問題**: 保存先が不明確
- **解決**: process_data.ipynbの冒頭に詳細な説明を記載
- **場所**: 
  - ラベル画像: `Images/labels_seg/`, `Images/labels_obb/`
  - メタデータ: プロジェクトルート（CSV, JSON）

### ノートブックの構造
- **方針**: 各処理を独立したセルに分離
- **理由**: デバッグが容易、再実行が可能
- **構成**: 関数定義 → データ読み込み → 処理実行 → 保存

## vis/occの定義修正（重要）

### 指摘と対応（2025-01-XX）
- **ユーザー指摘**: 「眼瞼のセグが眼瞼縁に囲まれた部分なので、眼瞼がない部分」
- **確認結果**: 眼瞼マスクの定義が逆だった！修正が必要
- **対応**: process_data.ipynbのコードを修正、experiment_plan.mdの定義を更新

### 眼瞼マスクの正しい定義
- **眼瞼マスク** = **眼瞼縁に囲まれた部分** = **眼球の露出部分**
- つまり：
  - 眼瞼マスクの中 = **見えている部分**（visible）
  - 眼瞼マスクの外 = **隠れている部分**（occluded）

### 修正前（誤り）
```python
iris_vis = iris ∩ (NOT eyelid)  # 誤り
iris_occ = iris ∩ eyelid        # 誤り
```

### 修正後（正しい）
```python
iris_vis = iris ∩ eyelid        # 虹彩 ∩ 眼瞼 = 見える
iris_occ = iris ∩ (NOT eyelid)  # 虹彩 ∩ (NOT 眼瞼) = 隠れている
```

### 数学的表現の修正
- `iris_vis = E_iris ∩ M_lid_dil` (交集合) - 虹彩のうち眼瞼マスクの中
- `iris_occ = E_iris \ M_lid_dil` (差集合) - 虹彩のうち眼瞼マスクの外

### 膨張処理の削除（2025-01-XX）
- **削除理由**: ピクセル単位で厳密にアノテーションしているため不要
- **削除内容**:
  - `mask_lid_dil`の生成コードを削除
  - vis/occの計算で`mask_lid`を直接使用
  - `DILATION_SIZE`設定を削除
  - experiment_plan.mdの膨張に関する記述を削除
- **教訓**: アノテーションの精度に合わせて処理を決定

## 次回改善すべき点

- [ ] 画像リサイズ時の処理（現在はラスター化のみ、元画像のリサイズも必要か？）
- [ ] メモリ効率（大量データ処理時のメモリ使用量）
- [ ] 並列処理（1000件以上の画像処理で時間短縮）
- [ ] エラーハンドリング（アノテーション欠落時の処理）
- [ ] データ可視化（生成したラベルの確認用）
- [x] vis/occの定義を明確化
- [x] 膨張処理を削除

## 参考にした情報

- CVAT XMLフォーマットの仕様
- GroupKFoldの公式ドキュメント
- PIL/Pillowでの楕円描画方法


## ノートブック運用の反省（Run All 安定化）

### 基本原則：定義されていない変数を参照しない
- **基本原則**: セル内で参照する変数・クラス・関数は、そのセルより前で必ず定義されていること
- **Run All 対応**: すべて実行時にエラーが発生しないよう、セルの順序と依存関係を厳密に管理

### 失敗事例と教訓
- **失敗事例**: モデル初期化セル（`model1 = Method1_EyelidEllipse().to(device)`）を、モデルクラス定義・エイリアス定義より前に配置し、`NameError` を誘発
- **原因**: 
  - セル新設時に旧セルの削除・無効化を失念
  - 定義されていない変数（`Method1_EyelidEllipse`）を参照していた
  - セル間の依存関係を意識せずに配置
- **対応**: 
  - 定義より前の初期化セルを削除（セル内容を空化）
  - 初期化セルをエイリアス定義（Cell 19）の後（Cell 27）に配置
  - セルの順序を「定義 → 初期化 → 学習 → 推論」に統一
- **教訓**: 
  1. **新セルを作る場合は、必ず旧セルを削除/無効化する**
  2. **定義されていない変数・クラス・関数を参照しない**
  3. **セル間の依存関係を明確にし、実行順序を保証する**
  4. **Run All で動作することを前提に設計する**
  5. **一箇所修正したら、他の該当箇所がないか必ず確認する（grepで全検索）**
  6. **データファイルの存在確認を忘れずに行う（特にラベルファイル）**

